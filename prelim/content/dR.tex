\chapter{Perturbation in the Detector Response}
\label{chap:dr}

Section \ref{sec:bg:rt} introduced the transport equation and the concept of adjoint transport.
Section \ref{sec:bg:pert} showed Greenspan's derivation of an equation for the perturbation in the detector response in operator notation.
In this section, an equation for the perturbation in the detector response in a form suitable for use by deterministic transport codes will be derived.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Perturbed Transport Equation}
\label{sec:dr:pte}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

A perturbed version of the transport equation is derived in this section.

The perturbed total cross section $\bar{\sigma}_t$, the perturbed scattering cross section $\bar{\sigma}_s$, and the angular flux in the perturbed system $\bar{\psi}$ are defined as follows:
\begin{equation}\label{eq:dr:sigma_t_bar}
  \bar{\sigma}_t\left(\vec{r},E\right) \equiv
  \sigma_t      \left(\vec{r},E\right) +
  \delta\sigma_t\left(\vec{r},E\right)
\end{equation}
\begin{multline}\label{eq:dr:sigma_s_bar}
  \bar{\sigma}_s\left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right) \equiv \\
  \sigma_s      \left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right) +
  \delta\sigma_s\left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right)
\end{multline}
\begin{equation}\label{eq:dr:psi_bar}
  \bar{\psi}\left(\vec{r},\hat{\Omega},E\right) \equiv
  \psi      \left(\vec{r},\hat{\Omega},E\right) +
  \delta\psi\left(\vec{r},\hat{\Omega},E\right).
\end{equation}

The transport equation is repeated here:
\begin{multline}\label{eq:dr:te}
  \hat{\Omega}\cdot\vec{\nabla}\psi\left(\vec{r},\hat{\Omega},E\right) +
  \sigma_t\left(\vec{r},E\right)\psi\left(\vec{r},\hat{\Omega},E\right) = \\
  \int_{4\pi}\int_0^\infty\sigma_s\left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right)\psi\left(\vec{r},\hat{\Omega}^\prime,E^\prime\right)dE^\prime d\hat{\Omega}^\prime +
  q\left(\vec{r},\hat{\Omega},E\right)
\end{multline}
or, in simpler terms,
\begin{equation}\label{eq:dr:te_simple}
  \hat{\Omega}\cdot\vec{\nabla}\psi +
  \sigma_t\psi -
  \iint\sigma_s\psi d\hat{\Omega}^\prime dE^\prime =
  q.
\end{equation}
The transport equation in perturbed system is given by
\begin{equation}\label{eq:dr:te_pert}
  \hat{\Omega}\cdot\vec{\nabla}\bar{\psi} +
  \bar{\sigma}_t\bar{\psi} -
  \iint\bar{\sigma}_s\bar{\psi} d\hat{\Omega}^\prime dE^\prime =
  q.
\end{equation}
Expanding the perturbed terms yields
\begin{equation}\label{eq:dr:te_pert_2}
  \hat{\Omega}\cdot\vec{\nabla}\left(\psi + \delta\psi\right) +
  \left(\sigma_t + \delta\sigma_t\right)\left(\psi + \delta\psi\right) -
  \iint\left(\sigma_s + \delta\sigma_s\right)\left(\psi + \delta\psi\right)d\hat{\Omega}^\prime dE^\prime =
  q.
\end{equation}
Subtracting the original transport equation yields
\begin{equation}\label{eq:dr:te_pert_3}
  \hat{\Omega}\cdot\vec{\nabla}\delta\psi +
  \left(\sigma_t\delta\psi + \delta\sigma_t\psi + \delta\sigma_t\delta\psi\right) - \\
  \iint\left(\sigma_s\delta\psi + \delta\sigma_s\psi + \delta\sigma_s\delta\psi\right)d\hat{\Omega}^\prime dE^\prime =
  0.
\end{equation}
In perturbation theory, it is common to discard the second-order terms.
The result of doing so is given by
\begin{equation}\label{eq:dr:te_pert_4}
  \hat{\Omega}\cdot\vec{\nabla}\delta\psi +
  \left(\sigma_t\delta\psi + \delta\sigma_t\psi\right) -
  \iint\left(\sigma_s\delta\psi + \delta\sigma_s\psi\right)d\hat{\Omega}^\prime dE^\prime =
  0.
\end{equation}
Finally, after rearranging terms, the equation becomes
\begin{equation}\label{eq:dr:pte}
  \hat{\Omega}\cdot\vec{\nabla}\delta\psi +
  \sigma_t\delta\psi -
  \iint\sigma_s\delta\psi d\hat{\Omega}^\prime dE^\prime =
  \iint\delta\sigma_s\psi d\hat{\Omega}^\prime dE^\prime - \delta\sigma_t\psi.
\end{equation}
Equation \ref{eq:dr:pte} is written in operator notation as
\begin{equation}
  H\delta\psi = -\delta H\psi.
\end{equation}

Equation \ref{eq:dr:pte} is notable because of its similarity to the original transport equation.
The terms on the left represent the transport operator $H$ operating on the perturbation in the flux $\delta\psi$.
The terms on the right represent the perturbation in the transport operator $\delta H$ operating on the unperturbed flux $\psi$.
The terms on the right can then be thought of as a ``perturbed source term.''

Thus, the perturbation in the angular flux can be calculated by solving the transport equation with unperturbed cross sections and with the external source equal to $-\delta H\psi$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Calculation of $\delta R$}
\label{sec:dr:dr}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Equation \ref{eq:bg:pt:green170a}, which is repeated here as
\begin{equation}\label{eq:dr:dr_operator}
  \delta R = \left<\psi^+,-\delta H\psi\right>,
\end{equation}
is an equation for the perturbation in the detector response.
The $\left<\right>$ notation indicates integration over all dependent variables ($\vec{r}$, $\hat{\Omega}$, and $E$), which means that $\delta R$ is a scalar.

However, it is useful to consider the a modified version of the equation where integration is only performed over $\hat{\Omega}$ and $E$; i.e.
\begin{equation}\label{eq:dr:dr_pos}
  \delta R\left(\vec{r}\right) =
  -\int_{4\pi}\int_0^\infty\psi^+\delta H\psi dEd\hat{\Omega}.
\end{equation}
This results in $\delta R$ being a function of position.
$\delta R\left(\vec{r}_0\right)$ is defined as the perturbation in the detector response given a perturbation in cross sections ($\delta H$) that only occurs at point $\vec{r}_0$.
The vector quantity $\delta R\left(\vec{r}\right)$ is constructed by calculating $\delta R\left(\vec{r}_0\right)$ for all values of $\vec{r}_0$.

Expanding the operator notation yields
\begin{multline}\label{eq:dr:dr_pos_expand}
  \delta R\left(\vec{r}\right) =
  \int_{4\pi}\int_0^\infty\Biggl(\psi^+\left(\vec{r},-\hat{\Omega},E\right) \times \\
  \Biggl(\int_{4\pi}\int_0^\infty\delta\sigma_s\left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right)\psi\left(\vec{r},\hat{\Omega}^\prime,E^\prime\right)dE^\prime d\hat{\Omega}^\prime - \\
  \delta\sigma_t\left(\vec{r},E\right)\psi\left(\vec{r},\hat{\Omega},E\right)\Biggr)\Biggr)dEd\hat{\Omega},
\end{multline}
which is unwieldy.
It can be broken up into total and scattering terms:
\begin{equation}\label{eq:dr:dr_terms}
  \delta R\left(\vec{r}\right) =
  \delta R_s\left(\vec{r}\right) -
  \delta R_t\left(\vec{r}\right).
\end{equation}

The total term $\delta R_t$ is given by
\begin{equation}\label{eq:dr:dr_t_term_1}
  \delta R_t\left(\vec{r}\right) =
  \int_{4\pi}\int_0^\infty\psi^+\left(\vec{r},-\hat{\Omega},E\right)\delta\sigma_t\left(\vec{r},E\right)\psi\left(\vec{r},\hat{\Omega},E\right)dEd\hat{\Omega}.
\end{equation}
It can be simplified because $\delta\sigma_t$ has no angular dependence:
\begin{equation}\label{eq:dr:dr_t_term_2}
  \delta R_t\left(\vec{r}\right) =
  \int_0^\infty\delta\sigma_t\left(\vec{r},E\right)\int_{4\pi}\psi\left(\vec{r},\hat{\Omega},E\right)\psi^+\left(\vec{r},-\hat{\Omega},E\right)d\hat{\Omega}dE.
\end{equation}
The final form of the equation for the total term results from the definition of the scalar contributon flux (Equation \ref{eq:bg:rt:scalar-contributon}):
\begin{equation}\label{eq:dr:dr_t_term}
  \delta R_t\left(\vec{r}\right) =
  \int_0^\infty\delta\sigma_t\left(\vec{r},E\right)\Phi\left(\vec{r},E\right)dE.
\end{equation}

The scattering term $\delta R_s$ is given by
\begin{multline}\label{eq:dr:dr_s_term_1}
  \delta R_s\left(\vec{r}\right) =
  \int_{4\pi}\int_0^\infty\psi^+\left(\vec{r},-\hat{\Omega},E\right) \times \\
  \left(\int_{4\pi}\int_0^\infty\delta\sigma_s\left(\vec{r},\hat{\Omega}^\prime\rightarrow\hat{\Omega},E^\prime\rightarrow E\right)\psi\left(\vec{r},\hat{\Omega}^\prime,E^\prime\right)dE^\prime d\hat{\Omega}^\prime\right)dEd\hat{\Omega}.
\end{multline}
If isotropic scattering is assumed, then the equation becomes
\begin{multline}\label{eq:dr:dr_s_term_2}
  \delta R_s\left(\vec{r}\right) =
  \int_{4\pi}\int_0^\infty\psi^+\left(\vec{r},-\hat{\Omega},E\right) \times \\
  \left(\int_0^\infty\delta\sigma_s\left(\vec{r},E^\prime\rightarrow E\right)\int_{4\pi}\psi\left(\vec{r},\hat{\Omega}^\prime,E^\prime\right)d\hat{\Omega}^\prime dE^\prime\right)dEd\hat{\Omega}.
\end{multline}
The final form of the equation for the total term results from the definition of the scalar flux (Equation \ref{eq:bg:rt:scalar-flux}):
\begin{equation}\label{eq:dr:dr_s_term}
  \delta R_s\left(\vec{r}\right) =
  \int_0^\infty\phi^+\left(\vec{r},E\right)\left(\int_0^\infty\delta\sigma_s\left(\vec{r},E^\prime\rightarrow E\right)\phi\left(\vec{r},E^\prime\right)dE^\prime\right)dE.
\end{equation}

Bringing the terms together yields the final equation for $\delta R\left(\vec{r}\right)$:

\begin{empheq}[box=\fbox]{multline}\label{eq:dr:dr_pos_final}
  \delta R\left(\vec{r}\right) =
  \int_0^\infty\phi^+\left(\vec{r},E\right)\left(\int_0^\infty\delta\sigma_s\left(\vec{r},E^\prime\rightarrow E\right)\phi\left(\vec{r},E^\prime\right)dE^\prime\right)dE - \\
  \int_0^\infty\delta\sigma_t\left(\vec{r},E\right)\Phi\left(\vec{r},E\right)dE.
\end{empheq}

Equation \ref{eq:dr:dr_pos_final} implies something profound: if $\psi$ and $\psi^+$ are known, then $\delta R$ can be calculated for any perturbations $\sigma_t$ and $\sigma_s$.
Thus, $\psi$ and $\psi^+$ only need to be calculated a single time in order to calculate the effects of making any perturbation anywhere in the geometry.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Implementation}
\label{sec:dr:implementation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

As was mentioned in Section \ref{sec:bg:rt:advantg}, ADVANTG can be configured to write the full forward and adjoint angular flux data to an HDF5 file via an undocumented feature.
However, additional data that is not possible to access via standard features is required in order to calculate $\delta R$.
Thus, ADVANTG's Python source code was modified to instruct it to write out the additional data to NumPy \cite{numpy} pickle files.
A list of all the data written out by ADVANTG after the source code modifications is as follows:

\begin{enumerate}
  \item Spatial mesh (x, y, and z)
  \item Energy groups (neutron and gamma)
  \item Quadrature weights used by the discrete ordinates solver
  \item Source locations (indices of the voxels that contain the source)
  \item Source strengths (for each source location)
  \item Source energy spectrum
  \item Response locations (indices of the voxels that contain the response)
  \item Response strengths (for each response location)
  \item Response energy spectrum
  \item Mix table (all material definitions, including mixed materials for voxels which contain multiple materials)
  \item Material map (shows which material is present in each voxel)
  \item Total cross section (for every material)
  \item Scattering cross section (for every material)
  \item Angular forward flux
  \item Angular adjoint flux
\end{enumerate}

C++ code was written to load the data and calculate $\delta R$.
(Python was tried first, but it was found to be far too slow.)
The CNPy \cite{cnpy} library was used to allow the C++ code to write the data as pickle files to allow for post-processing in Python.
